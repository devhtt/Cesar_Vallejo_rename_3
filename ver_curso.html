<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Ver Curso</title>
	<style>
		body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#f5f5f5}
		.container{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
		.header{margin-bottom:20px}
		.header h1{margin:0 0 8px 0;color:#222}
		.header p{margin:4px 0;color:#666;font-size:0.95rem}
		.section{margin-top:20px;padding:16px;background:#f9f9f9;border-left:4px solid #0078d4;border-radius:4px}
		.section h2{margin:0 0 12px 0;color:#0078d4;font-size:1.2rem}
		.images-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:12px}
		.image-box{border:1px solid #ddd;border-radius:4px;overflow:hidden;background:#fff}
		.image-box img{width:100%;height:120px;object-fit:cover}
		.rows-list{list-style:none;padding:0;margin:12px 0}
		.rows-list li{padding:10px;background:#fff;border:1px solid #ddd;border-radius:4px;margin-bottom:8px}
		.questions{margin-top:16px}
		.question{background:#fff;padding:16px;border:1px solid #ddd;border-radius:4px;margin-bottom:16px}
		.question h3{margin:0 0 12px 0;color:#222;font-size:1rem}
		.options{display:flex;flex-direction:column;gap:8px;margin-top:12px}
		.option{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;transition:0.2s}
		.option input[type="radio"]{cursor:pointer}
		.option:hover{background:#f9f9f9}
		.option.correct{background:#d4edda;border-color:#28a745}
		.option.incorrect{background:#f8d7da;border-color:#dc3545}
		.button{padding:10px 16px;border-radius:4px;border:1px solid #0078d4;background:#0078d4;color:#fff;cursor:pointer;font-size:0.95rem}
		.button.secondary{background:#f3f3f3;color:#222;border-color:#ccc}
	</style>
</head>
<body>
	<div class="container">
		<a class="button secondary" href="cursos.html">← Volver a cursos</a>
		<div id="courseContent"></div>
	</div>

	<script>
		function getQueryParam(name){
			const params = new URLSearchParams(location.search);
			return params.get(name);
		}

		function escapeHtml(str){
			if (!str) return '';
			return String(str)
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');
		}

		window.addEventListener('load', () => {
			const courseId = getQueryParam('id');
			if (!courseId) return;

			const all = JSON.parse(localStorage.getItem('cursos') || '[]');
			const course = all.find(c => String(c.id) === String(courseId));
			if (!course) return;

			// Registrar visita del usuario
			const userId = generateUserId();
			if (!course.usuariosIngresados) course.usuariosIngresados = [];
			if (!course.usuariosIngresados.includes(userId)) {
				course.usuariosIngresados.push(userId);
				// Actualizar localStorage
				const courseIdx = all.findIndex(c => String(c.id) === String(courseId));
				if (courseIdx >= 0) {
					all[courseIdx] = course;
					localStorage.setItem('cursos', JSON.stringify(all));
				}
			}

			const container = document.getElementById('courseContent');
			let html = `
				<div class="header">
					<h1>${escapeHtml(course.titulo)}</h1>
					<p><strong>Duración:</strong> ${course.duracion || 0} minutos</p>
					<p>${escapeHtml(course.contexto || '')}</p>
				</div>
			`;

			// Mostrar imágenes
			if (course.imagenes && course.imagenes.length > 0) {
				html += `<div class="section"><h2>Imágenes</h2><div class="images-grid">`;
				course.imagenes.forEach(img => {
					const imgData = img.data || img;
					html += `<div class="image-box"><img src="${escapeHtml(imgData)}" alt="imagen" /></div>`;
				});
				html += `</div></div>`;
			}

			// Mostrar renglones
			if (course.renglones && course.renglones.length > 0) {
				html += `<div class="section"><h2>Opciones / Renglones</h2><ul class="rows-list">`;
				course.renglones.forEach(row => {
					html += `<li>${escapeHtml(row)}</li>`;
				});
				html += `</ul></div>`;
			}

			// Mostrar preguntas
			if (course.preguntas && course.preguntas.length > 0) {
				html += `<div class="section"><h2>Preguntas</h2><div class="questions">`;
				course.preguntas.forEach((q, idx) => {
					html += `<div class="question">
						<h3>${escapeHtml(q.texto)}</h3>
						<div class="options">`;
					(q.opciones || []).forEach((opt, oIdx) => {
						const isCorrect = q.respuestaIdx === oIdx;
						html += `<label class="option">
							<input type="radio" name="q${idx}" value="${oIdx}" />
							<span>${escapeHtml(opt)}</span>
						</label>`;
					});
					html += `</div></div>`;
				});
				html += `</div></div>`;
			}

			container.innerHTML = html;

			// Interactividad de radio buttons
			const radios = container.querySelectorAll('input[type="radio"]');
			radios.forEach(radio => {
				radio.addEventListener('change', () => {
					const parentLabel = radio.closest('.option');
					const questionDiv = radio.closest('.question');
					const allOptions = questionDiv.querySelectorAll('.option');
					allOptions.forEach(opt => opt.classList.remove('correct', 'incorrect'));
					
					const qNameMatch = radio.name.match(/q(\d+)/);
					if (qNameMatch) {
						const qIdx = parseInt(qNameMatch[1]);
						const correctIdx = course.preguntas[qIdx].respuestaIdx;
						const selectedIdx = parseInt(radio.value);
						
						allOptions.forEach((opt, i) => {
							if (i === correctIdx) opt.classList.add('correct');
							if (i === selectedIdx && i !== correctIdx) opt.classList.add('incorrect');
						});
					}
				});
			});
		});

		function generateUserId(){
			let userId = localStorage.getItem('userId');
			if (!userId) {
				userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
				localStorage.setItem('userId', userId);
			}
			return userId;
		}
	</script>
</body>
</html>
